name: Build and Release PharmacyPOS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Environment and Build
        shell: bash  # Use bash for consistent scripting
        run: |
          # 1. Clean any existing Node interference
          echo "==> Removing existing Node from PATH"
          export PATH=$(echo $PATH | tr ':' '\n' | grep -v "node" | tr '\n' ':')
          
          # 2. Install Node.js 20 using the official installer
          echo "==> Installing Node.js 20"
          curl -fsSL https://nodejs.org/dist/v20.18.0/node-v20.18.0-win-x64.zip -o node.zip
          unzip -q node.zip -d /c/
          export PATH="/c/node-v20.18.0-win-x64:$PATH"
          
          # Verify installation
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          
          # 3. Install ALL dependencies from the project root
          echo "==> Installing root dependencies"
          npm ci
          
          # 4. Clean and install FRONTEND dependencies
          echo "==> Installing frontend dependencies"
          cd frontend
          # Critical fix for npm bug #4828
          rm -f package-lock.json
          rm -rf node_modules
          npm ci
          
          # 5. Install BACKEND dependencies
          echo "==> Installing backend dependencies"
          cd ../backend
          npm ci
          
          # 6. Build the frontend (NOW in the SAME shell)
          echo "==> Building frontend with Vite"
          cd ../frontend
          npm run build
          
          # 7. Build Electron app
          echo "==> Building Electron application"
          cd ..
          npx electron-builder --win portable --x64

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PharmacyPOS-Windows-Portable
          path: release/*.exe