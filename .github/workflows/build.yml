name: Build and Release PharmacyPOS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. FORCEFULLY install and use Node.js 20
      - name: Force Setup Node.js 20
        shell: bash
        run: |
          # Install nvm for Windows
          curl -o nvm-setup.exe -L https://github.com/coreybutler/nvm-windows/releases/latest/download/nvm-setup.exe
          ./nvm-setup.exe /NoRun
          
          # Reload PATH and install Node 20
          export NVM_HOME="$USERPROFILE/AppData/Roaming/nvm"
          export NVM_SYMLINK="$PROGRAMFILES/nodejs"
          export PATH="$NVM_HOME:$NVM_SYMLINK:$PATH"
          
          nvm install 20
          nvm use 20
          node --version  # Verify version

      # 2. Install all dependencies
      - name: Install All Dependencies
        run: |
          npm ci
          cd frontend
          # Clean install to fix npm bug #4828
          rm -f package-lock.json
          rm -rf node_modules
          npm ci
          cd ../backend
          npm ci

      # 3. Build Frontend
      - name: Build Frontend
        run: |
          cd frontend
          npm run build

      # 4. Build Electron
      - name: Build Electron for Windows
        run: npx electron-builder --win portable --x64

      # 5. Upload artifact
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PharmacyPOS-Windows-Portable
          path: release/*.exe