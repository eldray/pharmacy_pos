name: Build PharmacyPOS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    # 1. Get your code
    - uses: actions/checkout@v4
    
    # 2. THE FIX: Install and use Node 20 in ONE step
    - name: Build with Node 20
      run: |
        # Download and extract Node.js 20
        curl -fsSL https://nodejs.org/dist/v20.18.0/node-v20.18.0-win-x64.zip -o node.zip
        7z x node.zip -o"C:\"
        
        # Use this Node for EVERYTHING that follows
        $env:Path = "C:\node-v20.18.0-win-x64;" + $env:Path
        
        # Verify Node version
        node --version
        npm --version
        
        # Install root dependencies
        npm ci
        
        # Fix frontend dependencies (critical for npm bug)
        cd frontend
        Remove-Item -Force package-lock.json -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue
        npm ci
        
        # Install backend dependencies
        cd ../backend
        npm ci
        
        # Build frontend (THIS NOW USES NODE 20!)
        cd ../frontend
        npm run build
        
        # Build Electron app
        cd ..
        npx electron-builder --win portable --x64
      shell: pwsh

    # 3. Save the built .exe file
    - uses: actions/upload-artifact@v4
      with:
        name: PharmacyPOS-Windows
        path: release/*.exe